<!doctype html>
<html lang="en"> 
<head>
  <meta charset="UTF-8">
  <title>Touch plamp</title>
  
  <style type="text/css">
  .touchArea {
    width:100px;
    height:256px;
    background:#333;
    font-size:20px;
    color:#fff;
    text-align: center;
  }
  </style>
</head>
<body>

Plamp :-)
<table>
    <tr>
        <td><div class="touchArea" id="R"></div></td>
        <td><div class="touchArea" id="G"></div></td>
        <td><div class="touchArea" id="B"></div></td>
    </tr>
</table>

<!-- <script type="text/javascript" src="/js/jquery.min.js"></script> -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script type="text/javascript" src="/js/socket.io.min.js"></script>
<script type="text/javascript" src="/js/plamp.js"></script>

  <script type="text/javascript">
'use strict'

console.log('Init touch')

var getPointerEvent = function(event) {
    return event.originalEvent.targetTouches ? event.originalEvent.targetTouches[0] : event;
};

function componentToHex(c) {
    var hex = c.toString(16);
    return hex.length == 1 ? "0" + hex : hex;
}

function rgbToHex(r, g, b) {
    return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
}

var socket = null;
var R=0;
var G=0;
var B=0;

$(function() {
  console.log('UI setup')
  setup('#R')
  setup('#G')
  setup('#B')
  socket = io.connect('/plamp');
})

function setup(id)
{
    var $touchArea = $(id)
    var touchStarted = false // detect if a touch event is sarted
    var currX = 0
    var currY = 0
    var cachedX = 0
    var cachedY = 0 

 //setting the events listeners
 $touchArea.on('touchstart mousedown',function (e){
    e.preventDefault(); 
    var pointer = getPointerEvent(e);
    // caching the current x
    cachedX = currX = pointer.pageX;
    // caching the current y
    cachedY = currY = pointer.pageY;
    // a touch event is detected      
    touchStarted = true;
    $touchArea.text('Touchstarted ' + currX + ", " + currY);
    // detecting if after 200ms the finger is still in the same position
    setTimeout(function (){
        if ((cachedX === currX) && !touchStarted && (cachedY === currY)) {
            // Here you get the Tap event
            $touchArea.text('Tap [' + currX + ", " + currY + ']');
        }
    },200);
});
    
$touchArea.on('touchend mouseup touchcancel',function (e){
    e.preventDefault();
    // here we can consider finished the touch event
    touchStarted = false;
    var pointer = getPointerEvent(e);
    currX = pointer.pageX;
    currY = pointer.pageY;
    $touchArea.text('Touchended [' + currX + ", " + currY + ']');
});
       
$touchArea.on('touchmove mousemove',function (e){

   console.log('xxx[' + R + ',' + G +','+ B + ',0]')
    e.preventDefault();
    var pointer = getPointerEvent(e);
    currX = pointer.pageX;
    currY = pointer.pageY - 18;
    var col = currY < 0? 0 : currY
    if (col > 255)  col = 0 
    $touchArea.text('[' + currY + ']');
    if (id == "#R")
    {
      R = col
      $touchArea.css("backgroundColor", rgbToHex(col, 0, 0) )
    }
    if (id == "#G")
    {
      G = col
      $touchArea.css("backgroundColor", rgbToHex(0, col, 0) )
    }  
    if (id == "#B")
    {
      B = col
      $touchArea.css("backgroundColor", rgbToHex(0, 0, col) )
    }
    //
    // ===============
    var msg = '[' + R + ',' + G +','+ B + ',0]'
    console.log('emit ' + msg)
    socket.emit('color_wipe', msg)    
    // ===============
    if(touchStarted) {
         // here you are swiping
         $touchArea.text('Swiping [' + currX + ", " + currY + ']');
    }
   
});
    
}
  </script>
</body>
</html>
